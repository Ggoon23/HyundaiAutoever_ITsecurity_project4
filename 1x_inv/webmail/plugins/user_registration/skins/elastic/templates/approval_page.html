<roundcube:object name="doctype" value="html5" />
<html>
<head>
<title><roundcube:object name="pagetitle" /></title>
<roundcube:include file="/includes/links.html" />
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

.approval-container {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 30px;
}

.approval-header {
    border-bottom: 3px solid #2196F3;
    padding-bottom: 20px;
    margin-bottom: 30px;
}

.approval-header h1 {
    color: #2196F3;
    margin: 0 0 10px 0;
    font-size: 28px;
}

.approval-header p {
    color: #666;
    margin: 0;
}

.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.stat-card.pending {
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
}

.stat-card.approved {
    background: linear-gradient(135deg, #4CAF50 0%, #388E3C 100%);
}

.stat-card.rejected {
    background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%);
}

.stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    opacity: 0.9;
}

.stat-card .number {
    font-size: 32px;
    font-weight: bold;
    margin: 0;
}

.users-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.users-table thead {
    background: #f5f5f5;
}

.users-table th {
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #ddd;
}

.users-table td {
    padding: 12px;
    border-bottom: 1px solid #eee;
}

.users-table tr:hover {
    background: #f9f9f9;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-pending {
    background: #FFF3E0;
    color: #E65100;
}

.status-approved {
    background: #E8F5E9;
    color: #2E7D32;
}

.status-rejected {
    background: #FFEBEE;
    color: #C62828;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    padding: 6px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s;
}

.btn-approve {
    background: #4CAF50;
    color: white;
}

.btn-approve:hover {
    background: #388E3C;
}

.btn-reject {
    background: #F44336;
    color: white;
}

.btn-reject:hover {
    background: #D32F2F;
}

.back-link {
    margin-top: 20px;
    text-align: center;
}

.back-link a {
    color: #2196F3;
    text-decoration: none;
}

.back-link a:hover {
    text-decoration: underline;
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #999;
}
</style>

<script>
function approveUser(userId, email) {
    if (confirm('사용자 "' + email + '"을(를) 승인하시겠습니까?')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = './?_task=login&_action=plugin.user_approve';

        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_user_id';
        input.value = userId;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function rejectUser(userId, email) {
    if (confirm('사용자 "' + email + '"을(를) 거부하시겠습니까?')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = './?_task=login&_action=plugin.user_reject';

        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = '_user_id';
        input.value = userId;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
</head>
<body>

<div class="approval-container">
    <div class="approval-header">
        <h1>👥 회원 승인 관리</h1>
        <p>인사팀 전용 - 신규 가입 사용자 승인/거부</p>
    </div>

    <roundcube:object name="message" id="message" />

    <div class="stats-section">
        <div class="stat-card pending">
            <h3>승인 대기</h3>
            <p class="number" id="pending-count">-</p>
        </div>
        <div class="stat-card approved">
            <h3>승인 완료</h3>
            <p class="number" id="approved-count">-</p>
        </div>
        <div class="stat-card rejected">
            <h3>거부됨</h3>
            <p class="number" id="rejected-count">-</p>
        </div>
        <div class="stat-card">
            <h3>전체</h3>
            <p class="number" id="total-count">-</p>
        </div>
    </div>

    <h2 style="margin-top: 30px; color: #333;">📋 가입 신청 목록</h2>

    <table class="users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>이메일</th>
                <th>이름</th>
                <th>부서</th>
                <th>신청일</th>
                <th>상태</th>
                <th>처리일</th>
                <th>작업</th>
            </tr>
        </thead>
        <tbody id="users-tbody">
            <?php
            $rcmail = rcmail::get_instance();
            $db = $rcmail->get_dbh();

            // 통계
            $stats = array('pending' => 0, 'approved' => 0, 'rejected' => 0, 'total' => 0);

            $query = "SELECT COUNT(*) as cnt, status FROM registration_pending GROUP BY status";
            $result = $db->query($query);
            while ($row = $db->fetch_assoc($result)) {
                $stats[$row['status']] = $row['cnt'];
                $stats['total'] += $row['cnt'];
            }

            echo "<script>
                document.getElementById('pending-count').textContent = '{$stats['pending']}';
                document.getElementById('approved-count').textContent = '{$stats['approved']}';
                document.getElementById('rejected-count').textContent = '{$stats['rejected']}';
                document.getElementById('total-count').textContent = '{$stats['total']}';
            </script>";

            // 사용자 목록
            $query = "SELECT * FROM registration_pending ORDER BY created_at DESC";
            $result = $db->query($query);

            if ($db->num_rows($result) == 0) {
                echo '<tr><td colspan="8" class="no-data">등록된 사용자가 없습니다.</td></tr>';
            } else {
                while ($row = $db->fetch_assoc($result)) {
                    $status_class = 'status-' . $row['status'];
                    $status_text = array(
                        'pending' => '대기중',
                        'approved' => '승인됨',
                        'rejected' => '거부됨'
                    );

                    echo '<tr>';
                    echo '<td>' . htmlspecialchars($row['id']) . '</td>';
                    echo '<td><strong>' . htmlspecialchars($row['email']) . '</strong></td>';
                    echo '<td>' . htmlspecialchars($row['name']) . '</td>';
                    echo '<td>' . htmlspecialchars($row['department']) . '</td>';
                    echo '<td>' . date('Y-m-d H:i', strtotime($row['created_at'])) . '</td>';
                    echo '<td><span class="status-badge ' . $status_class . '">' . $status_text[$row['status']] . '</span></td>';
                    echo '<td>' . ($row['approved_at'] ? date('Y-m-d H:i', strtotime($row['approved_at'])) : '-') . '</td>';
                    echo '<td>';

                    if ($row['status'] === 'pending') {
                        echo '<div class="action-buttons">';
                        echo '<button class="btn btn-approve" onclick="approveUser(' . $row['user_id'] . ', \'' . htmlspecialchars($row['email']) . '\')">승인</button>';
                        echo '<button class="btn btn-reject" onclick="rejectUser(' . $row['user_id'] . ', \'' . htmlspecialchars($row['email']) . '\')">거부</button>';
                        echo '</div>';
                    } else {
                        echo '-';
                    }

                    echo '</td>';
                    echo '</tr>';
                }
            }
            ?>
        </tbody>
    </table>

    <div class="back-link">
        <a href="./?_task=mail">← 메일함으로 돌아가기</a>
    </div>
</div>

</body>
</html>
