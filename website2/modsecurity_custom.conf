# ================================================
# Custom ModSecurity Rules for PHP Upload Protection
# ================================================

# Rule ID 범위: 999001-999999 (커스텀 룰)

# ================================================
# 1. PHP 웹쉘 패턴 탐지
# ================================================

# system(), exec(), passthru(), shell_exec() 함수 차단
SecRule REQUEST_BODY "@rx (?:system|exec|passthru|shell_exec|eval|assert|base64_decode|gzinflate|str_rot13|preg_replace.*\/e)\s*\(" \
    "id:999001,\
    phase:2,\
    block,\
    log,\
    msg:'PHP Code Execution Function Detected',\
    severity:CRITICAL,\
    tag:'attack-injection-php',\
    tag:'OWASP_CRS',\
    setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# $_GET, $_POST, $_REQUEST 사용 의심 패턴
SecRule REQUEST_BODY "@rx \$_(GET|POST|REQUEST|COOKIE|SERVER|FILES)\[" \
    "id:999002,\
    phase:2,\
    block,\
    log,\
    msg:'PHP Superglobal Variable Detected',\
    severity:WARNING,\
    tag:'attack-injection-php',\
    setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}'"

# ================================================
# 2. 악성 파일명 탐지
# ================================================

# shell, backdoor, webshell, cmd 등 파일명 차단
SecRule FILES_NAMES "@rx (?i)(?:shell|backdoor|webshell|cmd|hack|pwn|exploit|payload|malware|trojan|virus)" \
    "id:999003,\
    phase:2,\
    block,\
    log,\
    msg:'Malicious Filename Detected in Upload',\
    severity:CRITICAL,\
    tag:'attack-upload-malicious',\
    setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# .php, .phtml, .php3, .php4, .php5 업로드 차단
SecRule FILES_NAMES "@rx \.(?:php[345]?|phtml|pht|phps|phar)$" \
    "id:999004,\
    phase:2,\
    block,\
    log,\
    msg:'PHP File Upload Blocked',\
    severity:CRITICAL,\
    tag:'attack-upload-php',\
    setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# ================================================
# 3. 웹쉘 코드 패턴 탐지
# ================================================

# <?php ?> 태그 탐지
SecRule FILES_TMPNAMES "@inspectFile /tmp/detect_php.sh" \
    "id:999005,\
    phase:2,\
    block,\
    log,\
    msg:'PHP Code Detected in Uploaded File',\
    severity:CRITICAL,\
    tag:'attack-upload-webshell'"

# 간단한 PHP 시작 태그 탐지
SecRule REQUEST_BODY "@rx <\?(?:php|=)" \
    "id:999006,\
    phase:2,\
    block,\
    log,\
    msg:'PHP Opening Tag Detected',\
    severity:CRITICAL,\
    tag:'attack-injection-php',\
    setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# ================================================
# 4. 파일 업로드 크기 제한
# ================================================

SecRule REQUEST_HEADERS:Content-Length "@gt 5242880" \
    "id:999007,\
    phase:1,\
    block,\
    log,\
    msg:'File Upload Too Large (>5MB)',\
    severity:WARNING,\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# ================================================
# 5. SQL Injection 패턴 (추가 보안)
# ================================================

SecRule ARGS "@detectSQLi" \
    "id:999008,\
    phase:2,\
    block,\
    log,\
    msg:'SQL Injection Detected',\
    severity:CRITICAL,\
    tag:'attack-sqli',\
    setvar:'tx.anomaly_score_pl2=+%{tx.critical_anomaly_score}'"

# ================================================
# 6. XSS 패턴 (추가 보안)
# ================================================

SecRule ARGS "@detectXSS" \
    "id:999009,\
    phase:2,\
    block,\
    log,\
    msg:'XSS Attack Detected',\
    severity:WARNING,\
    tag:'attack-xss',\
    setvar:'tx.anomaly_score_pl2=+%{tx.warning_anomaly_score}'"

# ================================================
# 7. Rate Limiting (Denial of Service 방지)
# ================================================

SecRule REQUEST_URI "@streq /api/submit_inquiry.php" \
    "id:999010,\
    phase:1,\
    pass,\
    log,\
    msg:'File Upload API Accessed',\
    setvar:'ip.upload_count=+1',\
    expirevar:'ip.upload_count=60'"

SecRule IP:UPLOAD_COUNT "@gt 10" \
    "id:999011,\
    phase:1,\
    block,\
    log,\
    msg:'Too Many Upload Requests (Rate Limit)',\
    severity:WARNING,\
    setvar:'tx.anomaly_score_pl1=+%{tx.warning_anomaly_score}'"

# ================================================
# 8. 디버그 로그 (개발용)
# ================================================

SecRule REQUEST_METHOD "@streq POST" \
    "id:999099,\
    phase:2,\
    pass,\
    log,\
    msg:'POST Request Logged',\
    logdata:'URI: %{REQUEST_URI}, Body: %{REQUEST_BODY}'"
